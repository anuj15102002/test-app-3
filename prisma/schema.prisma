// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Note that some adapters may set a maximum length for the String type by default, please ensure your strings are long
// enough when changing adapters.
// See https://www.prisma.io/docs/orm/reference/prisma-schema-reference#string for more information
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

model PopupConfig {
  id              String   @id @default(cuid())
  shop            String
  type            String   // "email" or "wheel"
  title           String
  description     String
  placeholder     String?
  buttonText      String
  discountCode    String?
  backgroundColor String
  textColor       String
  buttonColor     String?
  borderRadius    Int?
  showCloseButton Boolean  @default(true)
  displayDelay    Int      @default(3000)
  segments        String?  @db.Text // JSON string for wheel segments
  backgroundType  String?  // "gradient", "solid", "custom" - for wheel popup background type
  isActive        Boolean  @default(true)
  // New frequency and exit intent features
  frequency       String   @default("once")     // "once", "daily", "weekly", "always"
  exitIntent      Boolean  @default(false)     // Enable exit intent detection
  exitIntentDelay Int      @default(1000)      // Delay before exit intent triggers (ms)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([shop])
}

model DiscountCode {
  id              String   @id @default(cuid())
  shop            String
  email           String
  code            String   @unique
  discountType    String   // "percentage" or "fixed_amount"
  discountValue   String
  priceRuleId     String?  // Shopify Price Rule ID
  discountCodeId  String?  // Shopify Discount Code ID
  isActive        Boolean  @default(true)
  usageCount      Int      @default(0)
  usageLimit      Int      @default(1)
  startsAt        DateTime @default(now())
  endsAt          DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([shop])
  @@index([email])
  @@index([code])
}

model PopupAnalytics {
  id              String   @id @default(cuid())
  shop            String
  eventType       String   // "view", "email_entered", "spin", "win", "lose", "close", "copy_code"
  email           String?  // Only for email_entered, win events
  discountCode    String?  // Only for win events
  prizeLabel      String?  // What prize was won/lost
  userAgent       String?  // Browser info
  ipAddress       String?  // User IP (hashed for privacy)
  sessionId       String?  // Track user sessions
  timestamp       DateTime @default(now())
  metadata        String?  @db.Text // JSON string for additional data

  @@index([shop])
  @@index([eventType])
  @@index([timestamp])
  @@index([shop, eventType])
}
