<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="shopify-app-url" content="http://localhost:38975">
    <title>Test Popup</title>
    <script>
        // Simulate Shopify environment
        window.Shopify = {
            shop: 'appdevelopmentst.myshopify.com'
        };
    </script>
</head>
<body>
    <h1>Test Shopify Store Page</h1>
    <p>This page simulates a Shopify storefront to test the popup extension.</p>
    
    <!-- Include the popup display block -->
    <div id="custom-popup-overlay" style="display: none;">
      <div id="custom-popup" class="custom-popup">
        <div class="popup-content">
          <div class="popup-header">
            <span class="popup-icon"></span>
            <h3 class="popup-title"></h3>
            <button class="popup-close" onclick="closePopup()">&times;</button>
          </div>
          <p class="popup-description"></p>
          <div class="popup-form">
            <!-- Content will be dynamically inserted here -->
          </div>
        </div>
      </div>
    </div>

    <style>
    #custom-popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease-out;
    }

    .custom-popup {
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      max-width: 400px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      animation: popupSlideIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes popupSlideIn {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .popup-content {
      padding: 24px;
      text-align: center;
    }

    .popup-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
      position: relative;
    }

    .popup-icon {
      font-size: 24px;
    }

    .popup-title {
      font-size: 20px;
      font-weight: 600;
      margin: 0;
    }

    .popup-close {
      position: absolute;
      top: -10px;
      right: -10px;
      background: #f0f0f0;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
    }

    .popup-close:hover {
      background: #e0e0e0;
    }

    .popup-description {
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .popup-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .popup-button {
      width: 100%;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: opacity 0.2s ease;
    }

    .popup-button:hover {
      opacity: 0.9;
    }
    </style>

    <script>
    (() => {
      // Prevent duplicate loading
      if (window.__popupAlreadyLoaded) return;
      window.__popupAlreadyLoaded = true;

      let popupConfig = null;
      let popupShown = false;
      let exitIntentTriggered = false;

      // Utils
      const getShopDomain = () => window.Shopify?.shop || window.location.hostname;

      const fetchPopupConfig = async () => {
        const shopDomain = getShopDomain();
        const metaAppUrl = document.querySelector('meta[name="shopify-app-url"]')?.content;
        
        // Determine if we're in development mode
        const isDevelopment = window.location.hostname === 'localhost' || 
                             window.location.hostname === '127.0.0.1' ||
                             window.location.port;
        
        // Build endpoints list based on environment
        let endpoints = [];
        
        if (isDevelopment) {
          // In development, try local endpoints first
          endpoints = [
            `/api/public/popup-config?shop=${shopDomain}`,
            `http://localhost:38975/api/public/popup-config?shop=${shopDomain}`,
          ];
        } else if (metaAppUrl) {
          // In production with meta tag, use the app URL
          endpoints = [
            `${metaAppUrl}/api/public/popup-config?shop=${shopDomain}`,
          ];
        } else {
          // Fallback to relative URLs
          endpoints = [
            `/api/public/popup-config?shop=${shopDomain}`,
            `/apps/api/public/popup-config?shop=${shopDomain}`,
          ];
        }

        for (const endpoint of endpoints) {
          try {
            console.log('Fetching popup config from:', endpoint);
            const res = await fetch(endpoint, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            });
            if (res.ok) {
              const json = await res.json();
              console.log('Popup config received:', json);
              return json.config;
            } else {
              console.warn('Failed to fetch from endpoint:', endpoint, 'Status:', res.status);
            }
          } catch (err) {
            console.warn('Fetch failed for endpoint:', endpoint, err);
          }
        }

        // Fallback config
        console.log('Using fallback config');
        return {
          type: 'email',
          title: 'Fallback: Spin to Win!',
          description: 'Try your luck and win a discount!',
          buttonText: 'Spin Now!',
          backgroundColor: '#fff',
          textColor: '#000',
          buttonColor: '#007ace',
          placeholder: 'Enter your email',
          discountCode: 'SAVE10',
          borderRadius: 10,
          showCloseButton: true,
          displayDelay: 3000,
          frequency: 'once',
          isActive: true,
          exitIntent: false
        };
      };

      const shouldShowPopup = (config) => {
        const now = Date.now();
        const shownFlag = localStorage.getItem('popup-shown');
        const lastShown = parseInt(localStorage.getItem('popup-last-shown'), 10);
        switch (config.frequency) {
          case 'once':
            return !shownFlag;
          case 'daily':
            return !lastShown || now - lastShown > 86400000;
          case 'weekly':
            return !lastShown || now - lastShown > 604800000;
          case 'always':
            return true;
          default:
            return !shownFlag;
        }
      };

      const showPopup = (config) => {
        if (popupShown || !shouldShowPopup(config)) return;

        const overlay = document.getElementById('custom-popup-overlay');
        const popup = document.getElementById('custom-popup');
        const icon = popup.querySelector('.popup-icon');
        const title = popup.querySelector('.popup-title');
        const desc = popup.querySelector('.popup-description');
        const form = popup.querySelector('.popup-form');
        const closeBtn = popup.querySelector('.popup-close');

        overlay.style.display = 'flex';
        popup.style.backgroundColor = config.backgroundColor;
        popup.style.color = config.textColor;
        popup.style.borderRadius = `${config.borderRadius || 8}px`;
        title.textContent = config.title;
        desc.textContent = config.description;
        title.style.color = config.textColor;
        desc.style.color = config.textColor;
        closeBtn.style.display = config.showCloseButton === false ? 'none' : 'flex';

        if (config.type === 'email') {
          icon.textContent = 'ðŸ“§';
          form.innerHTML = `
            <input type="email" class="popup-input" id="popup-email" placeholder="${config.placeholder}" />
            <button class="popup-button" onclick="handleEmailSubmit()" style="background-color: ${config.buttonColor}; color: white;">
              ${config.buttonText}
            </button>
          `;
        }

        // Set localStorage
        popupShown = true;
        const now = Date.now().toString();
        if (config.frequency === 'once') {
          localStorage.setItem('popup-shown', 'true');
        } else {
          localStorage.setItem('popup-last-shown', now);
        }
      };

      const closePopup = () => {
        document.getElementById('custom-popup-overlay').style.display = 'none';
      };

      // Make closePopup global
      window.closePopup = closePopup;

      // Email handler
      window.handleEmailSubmit = function() {
        const email = document.getElementById('popup-email')?.value;
        if (email?.includes('@')) {
          alert(`Thank you! Use code ${popupConfig.discountCode} at checkout.`);
          closePopup();
        } else {
          alert('Please enter a valid email address.');
        }
      };

      // Init
      document.addEventListener('DOMContentLoaded', async () => {
        console.log('Initializing popup...');
        popupConfig = await fetchPopupConfig();
        console.log('Final popup config:', popupConfig);
        
        if (!popupConfig?.isActive) {
          console.log('Popup is not active');
          return;
        }

        // Clear localStorage for testing
        localStorage.removeItem('popup-shown');
        localStorage.removeItem('popup-last-shown');

        setTimeout(() => {
          console.log('Showing popup...');
          showPopup(popupConfig);
        }, popupConfig.displayDelay || 3000);
      });

      // Click outside to close
      document.addEventListener('click', (e) => {
        if (e.target.id === 'custom-popup-overlay') closePopup();
      });
    })();
    </script>
</body>
</html>